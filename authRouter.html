<script type="module">
    import {getAuth, onAuthStateChanged, signOut} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"
    const auth = getAuth();

    const handleResetPassword = (auth, actionCode) => {
        // Localize the UI to the selected language as determined by the lang
        // parameter.

        // Verify the password reset code is valid.
        auth.verifyPasswordResetCode(actionCode).then((email) => {
            const accountEmail = email;

            // TODO: Show the reset screen with the user's email and ask the user for
            // the new password.
            let newPassword = "...";

            // Save the new password.
           auth.confirmPasswordReset(actionCode, newPassword).then((resp) => {
                // Password reset has been confirmed and new password updated.

                // TODO: Display a link back to the app, or sign-in the user directly
                // if the page belongs to the same domain as the app:
                // auth.signInWithEmailAndPassword(accountEmail, newPassword);

                // TODO: If a continue URL is available, display a button which on
                // click redirects the user back to the app via continueUrl with
                // additional state determined from that URL's parameters.
            }).catch((error) => {
                // Error occurred during confirmation. The code might have expired or the
                // password is too weak.
            });
        }).catch((error) => {
            // Invalid or expired action code. Ask user to try to reset the password
            // again.
        });
    };

    const handleRecoverEmail = (auth, actionCode) => {
        // Localize the UI to the selected language as determined by the lang
        // parameter.
        let restoredEmail = null;
        // Confirm the action code is valid.
        auth.checkActionCode(actionCode).then((info) => {
            // Get the restored email address.
            restoredEmail = info['data']['email'];

            // Revert to the old email.
            return auth.applyActionCode(actionCode);
        }).then(() => {
            // Account email reverted to restoredEmail

            // TODO: Display a confirmation message to the user.

            // You might also want to give the user the option to reset their password
            // in case the account was compromised:
            auth.sendPasswordResetEmail(restoredEmail).then(() => {
                // Password reset confirmation sent. Ask user to check their email.
            }).catch((error) => {
                // Error encountered while sending password reset code.
            });
        }).catch((error) => {
            // Invalid code.
        });
    }


    const handleVerifyEmail = (auth, actionCode) => {
        // Localize the UI to the selected language as determined by the lang
        // parameter.
        // Try to apply the email verification code.
        auth.applyActionCode(actionCode).then((resp) => {
            // Email address has been verified.

            // TODO: Display a confirmation message to the user.
            // You could also provide the user with a link back to the app.

            // TODO: If a continue URL is available, display a button which on
            // click redirects the user back to the app via continueUrl with
            // additional state determined from that URL's parameters.
        }).catch((error) => {
            // Code is invalid or expired. Ask the user to verify their email address
            // again.
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // TODO: Implement getParameterByName()

        // Get the action to complete.
        const mode = getParameterByName('mode');
        // Get the one-time code from the query parameter.
        const actionCode = getParameterByName('oobCode');
        // (Optional) Get the continue URL from the query parameter if available.
        const continueUrl = getParameterByName('continueUrl');
        // (Optional) Get the language code if available.
        const lang = getParameterByName('lang') || 'en';

        // Handle the user management action.
        switch (mode) {
            case 'resetPassword':
                // Display reset password handler and UI.
                handleResetPassword(auth, actionCode, continueUrl, lang);
                break;
            case 'recoverEmail':
                // Display email recovery handler and UI.
                handleRecoverEmail(auth, actionCode, lang);
                break;
            case 'verifyEmail':
                // Display email verification handler and UI.
                handleVerifyEmail(auth, actionCode, continueUrl, lang);
                break;
            default:
            // Error: invalid mode.
        }
    }, false);
</script>