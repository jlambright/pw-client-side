<script type="module">
    import {getAuth} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"
    const auth = getAuth();
    const user = auth.currentUser;
    // This nonsense string is produced by the WebFlow variable templating.
    const storyId = "{{wf {&quot;path&quot;:&quot;story-id&quot;,&quot;type&quot;:&quot;PlainText&quot;\} }}";

    let headers = new Headers();
    headers.set("Accept", "application/json");

    const getVoteStatus = async (idToken) => {
        try {
            headers.set("Authorization", `Bearer ${idToken}`);

            const options = {
                headers: headers,
                method: "GET",
                cache: "default",
                username: user.email,
            }
            const response = await fetch(`https://api.purplewallstories.com/vote/${storyId}`, options);
            return await response.json();
        } catch (e) {
            console.log(`[Error when fetching vote status]`);
            console.log(e);
        }
    }

    const upVote = async () => {
        const idToken = await getIdToken();

        try {
            pendingVoteMsg.style.display = "block";
            preVote.style.display = "none";
            pendingVote.style.display = "block";
            if (idToken) {
                const options = {
                    headers: headers,
                    method: "POST"
                    username: user.email,
                }
                const response = await fetch(`https://api.purplewallstories.com/vote/${storyId}`, options);
                const body = await response.json();
                console.log(body.data);
                pendingVote.style.display = "none"
                postVoteMsg.style.display = "block";
                postVote.style.display = "block";
            } else {
                preVote.style.display = "none";
                cantVote.style.display = "block";
            }
        } catch (error) {
            const errorCode = error.code;
            const errorMessage = error.message;
            errorVoteMsg.innerText = `{${errorCode}}: ${errorMessage}`;
            errorVoteMsg.style.display = "block";
            pendingVote.style.display = "none";
            errorVote.style.display = "block";
            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
        }
    };

    getIdToken().then(async (idToken) => {
        try {
            if (manualVote.style.display !== "") {
                cantVote.style.display = "none";
            } else if (idToken) {
                const voteStatusResponse = await getVoteStatus(idToken);
                const {inRound, hasVoted} = voteStatusResponse.data;
                pendingVote.style.display = "none";
                if (!inRound) {
                    postVoteMsg.innerText = "try an active match up";
                    postVoteMsg.style.display = "block";
                    postVote.style.display = "block";
                } else if (hasVoted) {
                    postVoteMsg.innerText = "vote again tomorrow";
                    postVoteMsg.style.display = "block";
                    postVote.style.display = "block";
                } else if (!hasVoted && inRound) {
                    preVoteBtn.addEventListener("click", async (event) => {
                        event.preventDefault();
                        const voteResponse = await upVote();
                        console.log(voteResponse);
                    });
                    preVoteMsg.style.display = "block";
                    preVote.style.display = "block";
                } else {
                    errorVoteMsg.innerText = "report a bug";
                    errorVoteMsg.style.display = "block";
                    errorVote.style.display = "block";
                }
            } else {
                cantVoteMsg.style.display = "block";
                cantVote.style.display = "block";
                pendingVote.style.display = "none";
            }
        } catch (error) {
            const errorCode = error.code;
            const errorMessage = error.message;
            errorVoteMsg.innerText = `{${errorCode}}: ${errorMessage}`;
            errorVoteMsg.style.display = "block";
            pendingVote.style.display = "none";
            errorVote.style.display = "block";
            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
        }
    }).catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message;
        console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
    });
</script>