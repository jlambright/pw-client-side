<script type="application/javascript">
    const storyId = "STORY_ID_FROM_WEBFLOW_CMS";
    const getRoundMap = (idToken) => {
        const headers = new Headers();
        headers.append("Accept", "application/json");
        headers.append("Authorization", `Bearer ${idToken}`);

        const options = {
            headers: headers,
            method: "GET",
            cache: "default"
        }
        return fetch(`https://api.purplewallstories.com/round`, options)
    }
    const upVote = () => {
        return getIdToken().then((idToken) => {
            pendingVoteMsg.style.display = "block"
            preVote.style.display = "none";
            pendingVote.style.display = "block"
            if (idToken) {
                const headers = new Headers();
                headers.append("Accept", "application/json");
                headers.append("Authorization", `Bearer ${idToken}`);

                const options = {
                    headers: headers,
                    method: "POST"
                }
                return fetch(`https://api.purplewallstories.com/vote/${storyId}`, options)
                    .then((response) => {
                        return response.json().then((body) => {
                            console.log(body);
                            pendingVote.style.display = "none"
                            postVoteMsg.style.display = "block";
                            postVote.style.display = "block";
                        }).catch((error) => {
                            const errorCode = error.code;
                            const errorMessage = error.message;
                            errorVoteMsg.innerText = `{${errorCode}}: ${errorMessage}`;
                            errorVoteMsg.style.display = "block";
                            pendingVote.style.display = "none";
                            errorVote.style.display = "block";
                            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
                        });
                    }).catch((error) => {
                        const errorCode = error.code;
                        const errorMessage = error.message;
                        errorVoteMsg.innerText = `{${errorCode}}: ${errorMessage}`;
                        errorVoteMsg.style.display = "block";
                        pendingVote.style.display = "none";
                        errorVote.style.display = "block";
                        console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
                    });
            } else {
                preVote.style.display = "none";
                cantVote.style.display = "block";
            }
        }).catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
            errorVoteMsg.innerText = `{${errorCode}}: ${errorMessage}`;
            errorVoteMsg.style.display = "block";
            pendingVote.style.display = "none";
            errorVote.style.display = "block";
            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
        });
    };

    getIdToken()
        .then((idToken) => {
                if (idToken) getRoundMap(idToken)
                    .then((response) => {
                        return response.json().then(body => {
                            const roundMap = body.data;
                            if (roundMap.hasOwnProperty("stories") && roundMap.hasOwnProperty("matchups")) {
                                const stories = roundMap.stories;
                                const matchups = roundMap.matchups;

                                pendingVote.style.display = "none";
                                if (!(storyId in stories) || (matchups[stories[storyId].matchID].voters.includes(firebase.auth().currentUser.uid))) {
                                    if (!(storyId in roundMap.stories)) {
                                        postVoteMsg.innerText = "vote in an active match up";
                                    } else {
                                        postVoteMsg.innerText = "you've already voted for this match up today";
                                    }
                                    postVoteMsg.style.display = "block";
                                    postVote.style.display = "block";
                                } else {
                                    preVoteBtn.addEventListener("click", (event) => {
                                        event.preventDefault();
                                        upVote();
                                    });
                                    preVoteMsg.style.display = "block";
                                    preVote.style.display = "block";
                                }

                            } else {
                                errorVoteMsg.innerText = "that's embarrassing, looks like a bug";
                                errorVoteMsg.style.display = "block";
                                errorVote.style.display = "block";
                            }
                        }).catch((error) => {
                            const errorCode = error.code;
                            const errorMessage = error.message;
                            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
                        });
                    }).catch((error) => {
                        const errorCode = error.code;
                        const errorMessage = error.message;
                        console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
                    });
                else {
                    cantVoteMsg.style.display = "block";
                    cantVote.style.display = "block";
                    pendingVote.style.display = "none";
                }
            }
        ).catch((error) => {
        const errorCode = error.code;
        const errorMessage = error.message;
        console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
    });
</script>