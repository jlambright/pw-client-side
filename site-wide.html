<script type="module">
    import {getApp, initializeApp} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import {getAnalytics} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-analytics.js";
    import {getAuth, onAuthStateChanged, signOut} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"
    const firebaseConfig = {
        apiKey: "AIzaSyDJKlhCcgnNPS-ZywZrwxvkxY9MkEGMVIo",
        authDomain: "purple-wall.firebaseapp.com",
        projectId: "purple-wall",
        storageBucket: "purple-wall.appspot.com",
        messagingSenderId: "734351381182",
        appId: "1:734351381182:web:522802128154b9283b84ef",
        measurementId: "G-LGFTFBFZ37"
    };
    // Initialize Firebase
    initializeApp(firebaseConfig);
    const app = getApp();
    const analytics = getAnalytics();
    const auth = getAuth();

    const logLevels = Object.freeze({
        OTHER: 0,
        DEBUG: 1,
        INFO: 2,
        WARN: 3,
        ERROR: 4
    });

    /**
     * Returns a promise that resolves with an ID token if available.
     * @return {!Promise<?string>} The promise that resolves with an ID token if
     *     available. Otherwise, the promise resolves with null.
     */
    const getIdToken = () => {
        return new Promise((resolve, reject) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                unsubscribe();
                if (user) {
                    user.getIdToken().then((idToken) => {
                        postLogin.style.display = "block";
                        preLogin.style.display = "none";
                        resolve(idToken);
                    }, (error) => {
                        postLogin.style.display = "none";
                        preLogin.style.display = "block";
                        resolve(null);
                    });
                } else {
                    postLogin.style.display = "none";
                    preLogin.style.display = "block";
                    resolve(null);
                }
            });
        });
    };

    /**
     *
     * @param {"OTHER"|"DEBUG"|"INFO"|"WARN"|"ERROR"}level
     * @param {string} message
     * @param {object} data
     * @return {Promise<any>}
     */
    const submitLog = async (level, message, data) => {
        let headers = new Headers();
        headers.set("Accept", "application/json");

        try {
            if (level) {
                level = level.toUpperCase();
                if (logLevels.hasOwnProperty(level)){
                    data.level = level;
                    data.code = logLevels[level];
                }   else {
                    data.level = "OTHER";
                    data.code = logLevels.OTHER;
                }

                const options = {
                    headers: headers,
                    method: "POST",
                    cache: "default",
                    referrerPolicy: "origin-when-cross-origin",
                    body: data,
                }
                const response = await fetch(`https://api.purplewallstories.com/v1/logs`, options);
                return await response.json();
            } else {
                throw new TypeError("submitLog() -> Parameter \"level\" must be defined.")
            }

        } catch (error) {
            const errorCode = error.code;
            const errorMessage = error.message;
            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
        }

    }

    const getHref = () => {
        return document.referrer.includes(origin) ? document.referrer : origin;
    }

    const signOutUser = async () => {
        try {
            await signOut(auth);
            await  getIdToken();
            setTimeout(window.location.replace("/"), 1500);
        } catch (error) {
            const errorCode = error.code;
            const errorMessage = error.message;
            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
        }
    }

    signOutDrop.addEventListener("click", (event) => {
        event.preventDefault();
        signOutUser();
    });
    getIdToken();
    Object.assign(window, {app, auth, analytics, getHref, getIdToken, signOutUser, logLevels, submitLog});
</script>