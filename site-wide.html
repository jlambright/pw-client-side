<script type="module">
    import {getApp, initializeApp} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import {getAnalytics} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-analytics.js";
    import {getAuth, onAuthStateChanged, signOut} from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"
    const firebaseConfig = {
        apiKey: "AIzaSyDJKlhCcgnNPS-ZywZrwxvkxY9MkEGMVIo",
        authDomain: "purple-wall.firebaseapp.com",
        projectId: "purple-wall",
        storageBucket: "purple-wall.appspot.com",
        messagingSenderId: "734351381182",
        appId: "1:734351381182:web:522802128154b9283b84ef",
        measurementId: "G-LGFTFBFZ37"
    };
    // Initialize Firebase
    initializeApp(firebaseConfig);
    const app = getApp();
    const analytics = getAnalytics();
    const auth = getAuth();

    /**
     * Returns a promise that resolves with an ID token if available.
     * @return {!Promise<?string>} The promise that resolves with an ID token if
     *     available. Otherwise, the promise resolves with null.
     */
    const getIdToken = () => {
        return new Promise((resolve, reject) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                unsubscribe();
                if (user) {
                    user.getIdToken().then((idToken) => {
                        postLogin.style.display = "block";
                        preLogin.style.display = "none";
                        resolve(idToken);
                    }, (error) => {
                        postLogin.style.display = "none";
                        preLogin.style.display = "block";
                        resolve(null);
                    });
                } else {
                    postLogin.style.display = "none";
                    preLogin.style.display = "block";
                    resolve(null);
                }
            });
        });
    };

    const signOutUser = () => {
        return signOut(auth).then((response) => {
            console.log(response);
            return getIdToken()
                .finally(setTimeout(() => window.location.replace("/"), 150000))
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.log(`Error Code: ${errorCode}\nError Msg: ${errorMessage}`);
                });
        }).catch((error) => {
            const errorCode = error.code;
            const errorMessage = error.message;
            console.log(`Error Code: ${errorCode} \n Error Msg: ${errorMessage}`);
        });
    }

    signOutDrop.addEventListener("click", (event) => {
        event.preventDefault();
        signOutUser();
    });
    getIdToken();
    Object.assign(window, {app, auth, analytics, getIdToken, signOutUser});
</script>